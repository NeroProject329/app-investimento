generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  CLIENT
}

enum InvestorProfile {
  CONSERVADOR
  MODERADO
  AGRESSIVO
}

enum TxType {
  DEPOSIT
  WITHDRAW
  TRANSFER
  GAIN
  LOSS
  ADJUST
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  passwordHash       String
  role               Role     @default(CLIENT)
  mustChangePassword Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client Client?

  // âœ… NOVO
  auditLogs           AuditLog[]
  createdTransactions Transaction[] @relation("TxCreatedBy")
}

model Client {
  id       String          @id @default(cuid())
  userId   String          @unique
  fullName String
  phone    String?
  cpfCnpj  String          @unique
  profile  InvestorProfile

  user      User       @relation(fields: [userId], references: [id])
  portfolio Portfolio?
}

model Portfolio {
  id       String @id @default(cuid())
  clientId String @unique

  cashInvestmentId String?     @unique
  cashInvestment   Investment? @relation("CashInvestment", fields: [cashInvestmentId], references: [id])

  client       Client        @relation(fields: [clientId], references: [id])
  investments  Investment[]
  transactions Transaction[]
}

model InvestmentGroup {
  id   String @id @default(cuid())
  name String @unique

  investments Investment[]
}

model Investment {
  id          String   @id @default(cuid())
  portfolioId String
  groupId     String?
  name        String
  isCash      Boolean  @default(false)
  createdAt   DateTime @default(now())

  portfolio Portfolio        @relation(fields: [portfolioId], references: [id])
  group     InvestmentGroup? @relation(fields: [groupId], references: [id])

  // ðŸ‘‡ ADICIONE ISSO
  cashForPortfolio Portfolio? @relation("CashInvestment")

  txInvestment Transaction[] @relation("TxInvestment")
  txFrom       Transaction[] @relation("TxFrom")
  txTo         Transaction[] @relation("TxTo")

  @@index([portfolioId])
}

model Transaction {
  id          String   @id @default(cuid())
  portfolioId String
  type        TxType
  amountCents Int
  occurredAt  DateTime
  note        String?

  investmentId     String?
  fromInvestmentId String?
  toInvestmentId   String?

  // âœ… NOVO (quem lanÃ§ou)
  createdByUserId String?
  createdBy       User?   @relation("TxCreatedBy", fields: [createdByUserId], references: [id])

  portfolio Portfolio @relation(fields: [portfolioId], references: [id])

  investment Investment? @relation("TxInvestment", fields: [investmentId], references: [id])
  fromInv    Investment? @relation("TxFrom", fields: [fromInvestmentId], references: [id])
  toInv      Investment? @relation("TxTo", fields: [toInvestmentId], references: [id])

  @@index([portfolioId, occurredAt])
}

model AuditLog {
  id          String  @id @default(cuid())
  actorUserId String?
  actorUser   User?   @relation(fields: [actorUserId], references: [id])

  action     String
  entityType String
  entityId   String?
  metadata   Json?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([actorUserId, createdAt])
  @@index([entityType, entityId])
}
