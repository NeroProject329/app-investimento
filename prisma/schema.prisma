generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}




enum Role {
  ADMIN
  CLIENT
}

enum InvestorProfile {
  CONSERVADOR
  MODERADO
  AGRESSIVO
}

enum TxType {
  DEPOSIT
  WITHDRAW
  TRANSFER
  GAIN
  LOSS
  ADJUST
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  passwordHash       String
  role               Role     @default(CLIENT)
  mustChangePassword Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client Client?
}

model Client {
  id       String          @id @default(cuid())
  userId   String          @unique
  fullName String
  phone    String?
  cpfCnpj  String          @unique
  profile  InvestorProfile

  user      User       @relation(fields: [userId], references: [id])
  portfolio Portfolio?
}

model Portfolio {
  id               String @id @default(cuid())
  clientId         String @unique
  cashInvestmentId String @unique

  client Client @relation(fields: [clientId], references: [id])

  // ðŸ‘‡ nomeia a relaÃ§Ã£o "normal" (Portfolio -> Investments)
  investments Investment[] @relation("PortfolioInvestments")

  groups       InvestmentGroup[]
  transactions Transaction[]

  // ðŸ‘‡ relaÃ§Ã£o separada (Portfolio -> cashInvestment)
  cashInvestment Investment @relation("CashInvestment", fields: [cashInvestmentId], references: [id])
}

model InvestmentGroup {
  id          String @id @default(cuid())
  portfolioId String
  name        String

  portfolio   Portfolio    @relation(fields: [portfolioId], references: [id])
  investments Investment[]

  @@unique([portfolioId, name])
}

model Investment {
  id          String   @id @default(cuid())
  portfolioId String
  groupId     String?
  name        String
  isCash      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // ðŸ‘‡ lado oposto da relaÃ§Ã£o "normal"
  portfolio Portfolio @relation("PortfolioInvestments", fields: [portfolioId], references: [id])

  group InvestmentGroup? @relation(fields: [groupId], references: [id])

  // ðŸ‘‡ lado oposto da relaÃ§Ã£o "CashInvestment" (OBRIGATÃ“RIO existir)
  cashForPortfolio Portfolio? @relation("CashInvestment")

  txInvestment Transaction[] @relation("TxInvestment")
  txFrom       Transaction[] @relation("TxFrom")
  txTo         Transaction[] @relation("TxTo")

  @@index([portfolioId])
}

model Transaction {
  id          String   @id @default(cuid())
  portfolioId String
  type        TxType
  amountCents Int
  occurredAt  DateTime
  note        String?

  investmentId     String?
  fromInvestmentId String?
  toInvestmentId   String?

  portfolio Portfolio @relation(fields: [portfolioId], references: [id])

  investment Investment? @relation("TxInvestment", fields: [investmentId], references: [id])
  fromInv    Investment? @relation("TxFrom", fields: [fromInvestmentId], references: [id])
  toInv      Investment? @relation("TxTo", fields: [toInvestmentId], references: [id])

  @@index([portfolioId, occurredAt])
}
